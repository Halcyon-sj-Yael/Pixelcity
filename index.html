<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel City ‚Äî Build Together Simulator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600;700&family=Roboto+Mono:wght@400;500&family=Bungee&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .connection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .connection-modal.active {
            display: flex;
        }
        .connection-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .connection-box h2 {
            color: white;
            margin-bottom: 1rem;
            font-family: 'Orbitron', sans-serif;
        }
        .connection-box p {
            color: white;
            margin-bottom: 1rem;
            font-size: 14px;
        }
        .connection-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .connection-box button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .connection-box button:hover {
            transform: scale(1.05);
        }
        .connection-box .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .connection-error {
            color: #ffeb3b;
            margin-top: 10px;
            font-size: 14px;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèôÔ∏è Pixel City</h1>
            <p class="subtitle">Build Together Simulator</p>
        </header>

        <div class="game-area">
            <div class="sidebar">
                <div class="panel">
                    <h2>Resources</h2>
                    <div class="resource-display">
                        <div class="resource-item">
                            <span class="resource-label">Total Placed:</span>
                            <span class="resource-value" id="totalPlaced">0</span>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>Color Palette</h2>
                    <div class="color-palette" id="colorPalette">
                        <!-- Colors will be generated by JavaScript -->
                    </div>
                </div>

                <div class="panel">
                    <h2>Your Username</h2>
                    <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                        <input type="text" id="usernameDisplay" placeholder="Enter your name" maxlength="20" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                        <button id="updateUsernameBtn" class="btn btn-secondary" style="padding: 8px 15px; font-size: 12px;">Update</button>
                    </div>
                    <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 14px; color: #666;">Players Online</h3>
                    <div class="players-list" id="playersList">
                        <div class="player-item">You</div>
                    </div>
                </div>

                <div class="panel">
                    <h2>Instructions</h2>
                    <ul class="instructions">
                        <li>Click on the grid to place blocks</li>
                        <li>Select a color from the palette</li>
                        <li>Work together to build</li>
                    </ul>
                </div>

                <div class="panel chat-panel">
                    <h2>Chat</h2>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message system">
                            <span class="chat-time"></span>
                            <span class="chat-text">Welcome to Pixel City! Start chatting...</span>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." maxlength="200">
                        <button id="chatSendBtn" class="chat-send-btn">Send</button>
                    </div>
                </div>
            </div>

            <div class="main-area">
                <div class="canvas-container">
                    <canvas id="gameCanvas"></canvas>
                    <div class="grid-overlay" id="gridOverlay"></div>
                </div>
                <div class="controls">
                    <button id="connectBtn" class="btn btn-info">Connect to Server</button>
                    <button id="eraseModeBtn" class="btn btn-warning">Erase Mode</button>
                    <button id="undoBtn" class="btn btn-secondary">Undo Last</button>
                    <button id="clearBtn" class="btn btn-secondary">Clear Selection</button>
                    <button id="resetBtn" class="btn btn-danger">Reset Grid</button>
                    <button id="downloadBtn" class="btn btn-primary">Download Image</button>
                    <div class="connection-status">
                        <span id="connectionStatus" class="status-indicator offline">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Modal -->
    <div class="connection-modal" id="connectionModal">
        <div class="connection-box">
            <h2>üåê Connect to Server</h2>
            <p>Enter a server name to identify this server, and optionally an IP address if connecting to a friend's server.</p>
            <input type="text" id="serverNameInput" placeholder="Server name (e.g., My Server, Friend's Game)" maxlength="30" value="">
            <input type="text" id="serverAddressInput" placeholder="Server IP (optional - leave blank for localhost)" value="">
            <input type="text" id="usernameInput" placeholder="Your name/nickname (optional)" maxlength="20" value="">
            <div style="display: flex; gap: 10px;">
                <button id="connectSubmitBtn" style="flex: 1;">Connect</button>
                <button id="connectCancelBtn" class="btn-secondary" style="flex: 1;">Cancel</button>
            </div>
            <button id="connectLocalhostBtn" class="btn-success" style="width: 100%; margin-top: 10px; font-size: 14px;">
                üè† Quick Connect to Localhost
            </button>
            <div class="connection-error" id="connectionError"></div>
            
            <!-- Simple Server Start Option -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
                <button id="showServerStartBtn" class="btn-secondary" style="width: 100%; margin-bottom: 10px; font-size: 14px;">
                    üñ•Ô∏è Need to start a server?
                </button>
                <div id="serverStartInstructions" style="display: none; background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; font-size: 13px; color: white;">
                    <p style="margin: 0 0 10px 0; font-weight: bold; color: white;">Simple Steps:</p>
                    <ol style="margin: 0; padding-left: 20px; color: white;">
                        <li style="margin-bottom: 8px; color: white;">Open Terminal/Command Prompt</li>
                        <li style="margin-bottom: 8px; color: white;">Navigate to this folder</li>
                        <li style="margin-bottom: 8px; color: white;">Run: <code style="background: rgba(0, 0, 0, 0.3); padding: 2px 6px; border-radius: 4px; color: white;">npm start</code></li>
                        <li style="margin-bottom: 0; color: white;">Then click "Connect" above (leave IP blank for localhost)</li>
                    </ol>
                </div>
            </div>
            
            <p style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
                üí° Tip: Server name is just for your reference.<br>
                Leave IP blank to connect to localhost, or enter a friend's IP address.
            </p>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Connection dialog handling
        const connectionModal = document.getElementById('connectionModal');
        const serverNameInput = document.getElementById('serverNameInput');
        const serverAddressInput = document.getElementById('serverAddressInput');
        const usernameInput = document.getElementById('usernameInput');
        const connectSubmitBtn = document.getElementById('connectSubmitBtn');
        const connectCancelBtn = document.getElementById('connectCancelBtn');
        const connectionError = document.getElementById('connectionError');
        const connectBtn = document.getElementById('connectBtn');
        const showServerStartBtn = document.getElementById('showServerStartBtn');
        const serverStartInstructions = document.getElementById('serverStartInstructions');
        const connectLocalhostBtn = document.getElementById('connectLocalhostBtn');
        
        // Store server name in gameState
        if (!gameState.serverName) {
            gameState.serverName = 'Local Server';
        }
        
        // Username handling
        const usernameDisplay = document.getElementById('usernameDisplay');
        const updateUsernameBtn = document.getElementById('updateUsernameBtn');
        
        // Set initial username from gameState
        usernameDisplay.value = gameState.playerName;
        
        // Update username
        updateUsernameBtn.addEventListener('click', () => {
            const newName = usernameDisplay.value.trim();
            if (newName) {
                gameState.playerName = newName;
                // Send username update to server if connected
                if (gameState.ws && gameState.connected) {
                    gameState.ws.send(JSON.stringify({
                        type: 'updateUsername',
                        playerId: gameState.playerId,
                        playerName: newName
                    }));
                }
            }
        });
        
        usernameDisplay.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                updateUsernameBtn.click();
            }
        });

        // Check URL parameters for server address
        const urlParams = new URLSearchParams(window.location.search);
        const serverParam = urlParams.get('server');
        if (serverParam) {
            // Clean the server parameter
            let cleanParam = serverParam.trim();
            cleanParam = cleanParam.replace(/:\d+$/, ''); // Remove trailing port
            cleanParam = cleanParam.replace(/\s+.*$/, ''); // Remove any trailing text
            cleanParam = cleanParam.replace(/^ws:\/\//, ''); // Remove ws:// if present
            cleanParam = cleanParam.replace(/^wss:\/\//, ''); // Remove wss:// if present
            cleanParam = cleanParam.replace(/\/+$/, ''); // Remove trailing slashes
            cleanParam = cleanParam.replace(/^ws$/, ''); // Remove if just 'ws'
            cleanParam = cleanParam.replace(/^wss$/, ''); // Remove if just 'wss'
            cleanParam = cleanParam.trim();
            
            // Validate the cleaned parameter
            if (cleanParam && cleanParam !== 'ws' && cleanParam !== 'wss' && cleanParam.length > 0 && !cleanParam.match(/^ws:/)) {
                CONFIG.WS_URL = `ws://${cleanParam}:8080`.replace(/\/+$/, '');
                serverAddressInput.value = cleanParam;
            }
        }

        // Open connection modal
        connectBtn.addEventListener('click', () => {
            connectionModal.classList.add('active');
            // Pre-fill server name if we have one
            if (gameState.serverName) {
                serverNameInput.value = gameState.serverName;
            }
            // Hide server instructions by default
            serverStartInstructions.style.display = 'none';
            showServerStartBtn.textContent = 'üñ•Ô∏è Need to start a server?';
            serverNameInput.focus();
        });

        // Close modal
        connectCancelBtn.addEventListener('click', () => {
            connectionModal.classList.remove('active');
            connectionError.textContent = '';
            serverStartInstructions.style.display = 'none';
        });
        
        // Toggle server start instructions
        showServerStartBtn.addEventListener('click', () => {
            const isVisible = serverStartInstructions.style.display !== 'none';
            serverStartInstructions.style.display = isVisible ? 'none' : 'block';
            showServerStartBtn.textContent = isVisible ? 'üñ•Ô∏è Need to start a server?' : 'üñ•Ô∏è Hide instructions';
        });
        
        // Quick connect to localhost
        connectLocalhostBtn.addEventListener('click', () => {
            // Set localhost values
            serverNameInput.value = 'Local Server';
            serverAddressInput.value = 'localhost';
            gameState.serverName = 'Local Server';
            
            // Update username if provided
            const username = usernameInput.value.trim();
            if (username) {
                gameState.playerName = username;
                const usernameDisplay = document.getElementById('usernameDisplay');
                if (usernameDisplay) {
                    usernameDisplay.value = username;
                }
            }
            
            // Set WebSocket URL to localhost
            CONFIG.WS_URL = 'ws://localhost:8080';
            connectionError.textContent = '';
            connectionModal.classList.remove('active');
            
            // Update connection status
            updateConnectionStatus('offline', 'Connecting to Local Server...');
            
            // Disconnect existing connection if any
            if (gameState.ws) {
                gameState.ws.close();
                gameState.connected = false;
                gameState.isConnecting = false;
            }
            
            // Reset reconnect attempts for manual connection
            gameState.reconnectAttempts = 0;
            
            // Connect to localhost
            setTimeout(() => {
                connectWebSocket();
            }, 100);
        });

        // Connect to server
        connectSubmitBtn.addEventListener('click', () => {
            // Get server name (optional, defaults to "Local Server")
            const serverName = serverNameInput.value.trim() || 'Local Server';
            gameState.serverName = serverName;
            
            // Get server address (optional, defaults to localhost)
            let address = serverAddressInput.value.trim() || 'localhost';
            
            // Clean the address - remove any port numbers or extra text
            address = address.replace(/:\d+$/, ''); // Remove trailing port
            address = address.replace(/\s+.*$/, ''); // Remove any trailing text
            address = address.replace(/^ws:\/\//, ''); // Remove ws:// if present
            address = address.replace(/^wss:\/\//, ''); // Remove wss:// if present
            address = address.replace(/\/+$/, ''); // Remove trailing slashes
            address = address.replace(/^ws$/, ''); // Remove if just 'ws'
            address = address.replace(/^wss$/, ''); // Remove if just 'wss'
            address = address.trim();
            
            // Validate address
            if (!address || address === 'ws' || address === 'wss' || address.match(/^ws:/)) {
                address = 'localhost';
            }
            
            // Update username if provided
            const username = usernameInput.value.trim();
            if (username) {
                gameState.playerName = username;
                usernameDisplay.value = username;
            }

            // Update WebSocket URL with clean address
            if (address && address !== 'ws' && address !== 'wss' && !address.match(/^ws:/) && address.length > 0) {
                const constructedUrl = `ws://${address}:8080`.replace(/\/+$/, '');
                // Validate the constructed URL
                if (!constructedUrl.match(/^wss?:\/\/(ws|wss)(:|$)/)) {
                    CONFIG.WS_URL = constructedUrl;
                } else {
                    CONFIG.WS_URL = 'ws://localhost:8080';
                }
            } else {
                CONFIG.WS_URL = 'ws://localhost:8080';
            }
            connectionError.textContent = '';
            connectionModal.classList.remove('active');
            
            // Update connection status to show server name
            updateConnectionStatus('offline', `Connecting to ${serverName}...`);

            // Disconnect existing connection if any
            if (gameState.ws) {
                gameState.ws.close();
                gameState.connected = false;
                gameState.isConnecting = false;
            }
            
            // Reset reconnect attempts for manual connection
            gameState.reconnectAttempts = 0;

            // Connect to new server
            setTimeout(() => {
                connectWebSocket();
            }, 100);
        });

        serverNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                serverAddressInput.focus();
            }
        });
        
        serverAddressInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                usernameInput.focus();
            }
        });
        
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectSubmitBtn.click();
            }
        });
    </script>
</body>
</html>

